@startuml
title Folder Management (Create, Rename, Move, Delete)

start

:User requests folder operation;

partition "Traefik" {
    :Forward to File Service;
}

partition "Auth Middleware" {
    :Validate JWT;
    if (Invalid?) then (yes)
        :Return 401;
        stop
    endif
}

partition "File DB" {
    :Validate user owns target folder (or parent folder);

    if (Create?) then (yes)
        :Validate parent exists;
        :INSERT folder(parent_id, user_id, name);
        :Return new folder_id;
        stop
    endif

    if (Rename?) then (yes)
        :SELECT folder WHERE id = folder_id AND user_id = current_user;
        if (Not found?) then (yes)
            :Return 404;
            stop
        endif
        :UPDATE folder SET name=new_name;
        :Return success;
        stop
    endif

    if (Move?) then (yes)
        :Validate new_parent exists and belongs to user;
        :Check for cycles: ensure folder_id NOT in subtree(new_parent);
        if (Cycle?) then (yes)
            :Return 400 (invalid hierarchy);
            stop
        endif
        :UPDATE folder SET parent_id=new_parent;
        :Return success;
        stop
    endif

    if (Delete?) then (yes)
        :Check children count;
        if (Has children?) then (yes)
            :Return 400 (folder not empty);
            stop
        endif
        :DELETE folder;
        :Return success;
        stop
    endif
}

stop
@enduml
