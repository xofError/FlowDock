@startuml
title File Delete (Soft Delete + Local Disk Removal + Audit)

start

:User requests delete file;

partition "Traefik" {
    :Forward to File Service;
}

partition "Auth Middleware" {
    :Validate JWT;
    if (Invalid?) then (yes)
        :Return 401;
        stop
    endif
}

partition "DB" {
    :Fetch file metadata;
    if (Not exists?) then (yes)
        :Return 404;
        stop
    endif

    if (Not owner?) then (yes)
        :Return 403;
        stop
    endif

    :UPDATE files SET deleted=true, deleted_at=now();
}

partition "Disk" {
    :Delete file physically from /data/files/<uuid>;
}

partition "Activity Log" {
    :Record deletion (user_id, file_id);
}

:Return success;

stop
@enduml
