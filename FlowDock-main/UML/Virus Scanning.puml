@startuml
title Virus Scanning & Quarantine Pipeline (ClamAV, Quarantine, Admin Alert)

start

:Scan Worker consumes file.uploaded event from Kafka;

partition "Storage" {
  :Stream file object from MinIO/S3 to scanner;
}

partition "ClamAV" {
  :Scan stream (clamd or ClamAV-REST);
  if (scan returns error?) then (error)
    :Emit file.scan.error event with details;
    :Retry policy (exponential) -> after retries send to DLQ;
    stop
  endif
  if (infected?) then (yes)
    :Return infected + virus name;
  else (no)
    :Return clean;
  endif
}

if (infected?) then (yes)
  partition "File Service" {
    :Mark metadata status=INFECTED;
    :Move object to quarantine bucket (copy then delete original) or change tag/ACL;
    :Persist virus_scan_log (file_id, virus_name, scanner_version, timestamp);
  }
  partition "Notification & Admin" {
    :Publish file.infected event to Kafka;
    :Send aggregated alert to Admins (email/telegram);
    :Optionally notify owner with limited content (avoid leaking details);
  }
else (no)
  partition "File Service" {
    :Mark metadata status=AVAILABLE, update hash;
  }
  partition "Activity Service" {
    :Publish file.scanned.clean event to Kafka;
  }
endif

stop
@enduml
