@startuml
title Password Recovery Flow (Recovery Tokens + Redis + Email)

start

:User requests password reset;

partition "Traefik" {
    :Forward request to Auth Service;
}

partition "Rate Limiter (Redis)" {
    :INCR recovery_req:<ip>;
    if (Too many?) then (yes)
        :Return 429 Too Many Requests;
        stop
    endif
    :Set TTL on rate-limit key;
}

partition "Auth Service" {
    :Verify email exists;
    :Generate recovery token (random 32B);
    :Hash token;
    :Store hashed token in recovery_tokens table;
    :Set expires_at;
}

partition "Notification Service" {
    :Send recovery link to email/telegram;
}

:User clicks link and submits new password;

partition "Auth Service" {
    :Hash submitted token;
    :Check DB if exists + active + not expired;
    if (Valid?) then (yes)
        :Hash new password;
        :Update user's password;
        :Invalidate recovery token row;
    else (no)
        :Return invalid/expired token;
        stop
    endif
}

stop
@enduml
