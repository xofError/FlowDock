@startuml
title Refresh Token Exchange (Sessions, Revocation, JWT Rotation)

start

:Client sends refresh token;

partition "Traefik" {
    :Forward to Auth Service;
}

partition "Auth Service" {
    :Hash incoming refresh token;
    :Query sessions table for matching hash;
    if (Session exists?) then (yes)
        if (Session.active?) then (yes)
            if (Not expired?) then (yes)
                :Generate new access JWT;
                :Generate new refresh token;
                :Hash and update session row;
            else (no)
                :Mark session inactive;
                :Return session expired;
                stop
            endif
        else (no)
            :Return session revoked;
            stop
        endif
    else (no)
        :Return invalid refresh token;
        stop
    endif
}

:Return new tokens;

stop
@enduml
