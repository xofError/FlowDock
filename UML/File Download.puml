@startuml
title File Download (Local Disk + Access Check + Audit Log)

start

:User requests /download/<file_id>;

partition "Traefik" {
    :Route to File Service;
}

partition "Auth Service (Middleware)" {
    :Verify JWT;
    if (Valid?) then (yes)
        :Attach user_id;
    else (no)
        :Return 401;
        stop
    endif
}

partition "File Metadata DB" {
    :SELECT * FROM files WHERE id = file_id;
    if (Found?) then (yes)
        :Check owner_id == user_id OR shared access;
    else (no)
        :Return 404;
        stop
    endif

    if (Access allowed?) then (yes)
        :Proceed;
    else (no)
        :Return 403;
        stop
    endif
}

partition "Disk Storage" {
    :Locate file path /data/files/<uuid_name>;
    if (File exists?) then (yes)
        :Stream file to client;
    else (no)
        :Return 410 Gone;
        stop
    endif
}

partition "Activity Log" {
    :Record download (user_id, file_id, timestamp, ip);
}

stop
@enduml
