@startuml
title TOTP Enrollment (Secret Generation → QR → Verify → Activate)

start

:User requests TOTP enablement;

partition "Auth" {
    :Validate JWT;
    if (Invalid?) then (yes)
        :Return 401;
        stop
    endif
}

partition "Auth Service" {
    :Generate random TOTP secret (base32);
    :Store temp_secret in DB (not active);
    :Generate otpauth:// URI;
    :Generate QR code;
}

:Return QR image + secret;

stop

== VERIFICATION ==

start

:User submits 6-digit TOTP code;

partition "Auth Service" {
    :Retrieve temp_secret from DB;
    :Validate TOTP(code, temp_secret);
    if (Invalid?) then (yes)
        :Return 400 invalid code;
        stop
    endif

    :Move temp_secret → active_secret;
    :Mark user.2FA_enabled = true;
    :Delete temp_secret;
}

:Return success;

stop
@enduml
